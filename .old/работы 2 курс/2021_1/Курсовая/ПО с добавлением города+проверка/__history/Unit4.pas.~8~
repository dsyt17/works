unit Unit4;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Data.DB, Data.Win.ADODB, Vcl.Grids,
  Vcl.DBGrids, Vcl.StdCtrls, Vcl.CheckLst, Vcl.ExtCtrls, jpeg, Dbctrls,
  Vcl.ComCtrls, Vcl.Buttons, Vcl.ExtDlgs;

type
  TForm4 = class(TForm)
    Button1: TButton;
    ADOQuery1: TADOQuery;
    DataSource1: TDataSource;
    BitBtn1: TBitBtn;
    Image1: TImage;
    BitBtn2: TBitBtn;
    OpenDialog1: TOpenDialog;
    ADOQuery2: TADOQuery;
    DBGrid1: TDBGrid;
    Edit1: TEdit;
    Label1: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    Memo1: TMemo;
    Label4: TLabel;
    ComboBox1: TComboBox;
    ComboBox2: TComboBox;
    CheckListBox1: TCheckListBox;
    Button2: TButton;
    ADOQuery3: TADOQuery;
    ADOQuery4: TADOQuery;
    ADOQuery5: TADOQuery;
    ADOQuery6: TADOQuery;
    ADOQuery7: TADOQuery;
    procedure Button1Click(Sender: TObject);
    procedure DBGrid1TitleClick(Column: TColumn);
    procedure BitBtn1Click(Sender: TObject);
    procedure BitBtn2Click(Sender: TObject);
    procedure FormActivate(Sender: TObject);
    procedure SaveCityName(gname:string);
    procedure Button2Click(Sender: TObject);

  private
    { Private declarations }
  public
   Function GetIDCity(gname:string):integer;
   Function GetIDInfr(gname:string):integer;
  end;

var
  Form4: TForm4;

implementation

{$R *.dfm}

uses Unit3;

procedure TForm4.BitBtn1Click(Sender: TObject);
  begin
  if Opendialog1.execute then
      begin
        image1.picture.loadfromfile(opendialog1.filename);
      end;
  end;

procedure TForm4.BitBtn2Click(Sender: TObject);
var
j: tjpegimage;
b: tbitmap;
begin

adoquery2.edit;
if extractfileext(opendialog1.filename)='.bmp' then
TBlobField(adoquery2.fieldbyname('Фото')).assign(image1.picture)
else
begin
  j:=tjpegimage.create;
  try
     j.compressionquality:=100;
     j.loadfromfile(opendialog1.filename);
     b:=tbitmap.create;
     try
      b.assign(j);
      tblobfield(adoquery2.fieldbyname('Фото')).assign(b);
      finally
      b.free
     end;
      finally
     j.Free
  end;

end;
adoquery2.Post;
end;



procedure TForm4.Button1Click(Sender: TObject);
begin
form4.Close;
end;





procedure TForm4.Button2Click(Sender: TObject);
var i:integer;
begin
adoquery6.close;
adoquery6.open;
SaveCityName(edit1.text);
for i := 0 to checklistbox1.Items.Count-1 do
if checklistbox1.Checked[i] then
    begin
      adoquery5.open;
      adoquery5.Insert;
      adoquery5['idCity']:=GetIDCity(Edit1.text);
      adoquery5['idR']:=GetIDInfr(CheckListBox1.items[i]);
      adoquery5.post;
    end;

end;




procedure TForm4.DBGrid1TitleClick(Column: TColumn);
begin
 adoquery2.sort:=column.Field.Fieldname;
end;




procedure TForm4.FormActivate(Sender: TObject);
begin
      DBGrid1.Columns.Items[0].Width:=125;
      DBGrid1.Columns[0].Title.Caption:='Город';
      DBGrid1.Columns.Items[1].Visible:=False;
      DBGrid1.Columns[0].Title.Alignment:=tacenter;
      DBGrid1.Columns[0].Title.Font.Style:=[fsBold];


 with  ADOquery7 do
begin
ComboBox1.Items.clear;
DisableControls;
ComboBox1.Items.BeginUpdate;
First;
   while not Eof do
      begin
       ComboBox1.Items.Add(FieldByName('Название').AsString);
       Next;
      end;
ComboBox1.Items.EndUpdate;
EnableControls;
end;

end;

function TForm4.GetIDCity(gname: string): integer;
var aq:tadoquery;
begin
  aq:=tadoquery.Create(form4);
  aq.Connection:=form3.ADOConnection1;
  aq.SQL.Text:='select idCity from Город where Название_города=:n';
  aq.Parameters.ParamByName('n').Value:=gName;
  aq.Open;
  if aq.RecordCount>0 then result:=aq.Fields[0].AsInteger else result:=-1;
  aq.Free;
end;

function TForm4.GetIDInfr(gname: string): integer;
var aq:tadoquery;
begin
 aq:=tadoquery.Create(form4);
  aq.Connection:=form3.ADOConnection1;
  aq.SQL.Text:='select idR from Инфраструктура where Название_инф=:n';
  aq.Parameters.ParamByName('n').Value:=gName;
  aq.Open;
  if aq.RecordCount>0 then result:=aq.Fields[0].AsInteger else result:=-1;
  aq.Free;

end;

procedure TForm4.SaveCityName(gname:string);
var id:integer;
j: tjpegimage;
b: tbitmap;
aqt: tadoquery;
begin
adoquery3.open;
adoquery3.insert;
adoquery3['Название_города']:=edit1.Text;


aqt:=tadoquery.Create(form4);
aqt.Connection:=form3.ADOConnection1;
aqt.SQL.Text:='select idCountry from Страна where Название=:n';
aqt.Parameters.ParamByName('n').value:=combobox1.Text;
aqt.Open;
adoquery3['Страна']:=aqt.FieldByName('idCountry').Value;
aqt.Free;

if combobox2.Text='Малый' then adoquery3['Размер города']:='1';
if combobox2.Text='Средний' then adoquery3['Размер города']:='2';
if combobox2.Text='Крупный' then adoquery3['Размер города']:='3';
if combobox2.Text='Крупнейший' then adoquery3['Размер города']:='4';

adoquery3['Описание']:=memo1.text;
id:=adoquery6.FieldByName('Expr1000').Value;
id:=id+1;
adoquery3['Инфраструктура']:=id;

  if extractfileext(opendialog1.filename)='.bmp' then
  TBlobField(adoquery3.fieldbyname('Фото')).assign(image1.picture)
  else
  begin
    j:=tjpegimage.create;
    try
       j.compressionquality:=100;
       j.loadfromfile(opendialog1.filename);
       b:=tbitmap.create;
       try
        b.assign(j);
        tblobfield(adoquery3.fieldbyname('Фото')).assign(b);
        finally
        b.free
       end;
        finally
       j.Free
    end;



adoquery3.post;




end;
end;






end.
